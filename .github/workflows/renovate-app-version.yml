name: Update app version in Renovate Branches

on:
  push:
    branches: [ 'renovate/*' ]
  workflow_dispatch:
    inputs:
      manual-trigger:
        description: 'Manually trigger Renovate'
        default: ''

jobs:
  update-app-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --local user.email "githubaction@githubaction.com"
          git config --local user.name "github-action update-app-version"

      - name: Get list of updated files by the last commit
        id: updated-files
        run: |
          echo "files=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Run renovate-app-version.sh on updated files
        id: rename
        run: |
          set -e
          chmod +x .github/workflows/renovate-app-version.sh

          files="${{ steps.updated-files.outputs.files }}"
          declare -a changed_apps=()

          echo "Updated files: $files"

          for file in $files; do
            if [[ $file == *"docker-compose.yml"* ]]; then
              echo "Processing file: $file"

              app_name=$(echo $file | cut -d'/' -f 2)
              old_version=$(echo $file | cut -d'/' -f 3)
              echo "App name: $app_name, old version: $old_version"

              # è·å–æ‰€æœ‰æœåŠ¡å
              services=$(yq '.services | keys | .[]' "$file")
              service=""
              image_line=""

              for s in $services; do
                # é€šè¿‡awkè·å–æœåŠ¡ä¸‹çš„imageè¡Œï¼ˆåŒ…å«æ³¨é‡Šï¼‰
                image_line=$(awk "/services:/{flag=0} /^\s*$s:/{flag=1} flag && /^\s*image:/{print; exit}" "$file")
                echo "Service $s image line: $image_line"
                if [[ "$image_line" != *"[ignore]"* ]]; then
                  service="$s"
                  break
                else
                  echo "Skipping service $s due to [ignore]"
                fi
              done

              if [[ -z "$service" ]]; then
                echo "No valid service found in $file, skipping..."
                continue
              fi

              # æå–imageçº¯å­—ç¬¦ä¸²ï¼Œå»é™¤æ³¨é‡Šå’Œå¤šä½™ç©ºæ ¼
              image=$(echo "$image_line" | sed -E 's/^\s*image:\s*([^ #]+).*/\1/')
              echo "Selected service: $service"
              echo "Extracted image: $image"

              if [[ "$image" == *":"* ]]; then
                new_version=$(cut -d ":" -f2- <<< "$image")
                trimmed_version=${new_version/#"v"/}
                echo "Parsed new version: $trimmed_version"
              else
                trimmed_version=""
                echo "No version tag found in image."
              fi

              changed_apps+=("${app_name}:${old_version}:${trimmed_version}")
              echo "Calling renovate-app-version.sh with: $app_name, $old_version, $trimmed_version"
              .github/workflows/renovate-app-version.sh "$app_name" "$old_version" "$trimmed_version"
            fi
          done

          echo "All changed apps: ${changed_apps[*]}"
          echo "apps=$(IFS=, ; echo "${changed_apps[*]}")" >> $GITHUB_OUTPUT

      - name: Commit & Push Changes
        run: |
          set -e
          IFS=',' read -r -a apps <<< "${{ steps.rename.outputs.apps }}"
          for item in "${apps[@]}"; do
            app_name=$(cut -d':' -f1 <<< "$item")
            old_version=$(cut -d':' -f2 <<< "$item")
            new_version=$(cut -d':' -f3 <<< "$item")

            if [[ -n "$app_name" && -n "$new_version" ]]; then
              git add "apps/$app_name/*"
              git commit -m "ğŸ“ˆå°†åº”ç”¨ $app_name çš„ç‰ˆæœ¬ä» $old_version å‡çº§åˆ° $new_version [skip ci]" --no-verify || echo "æ— å†…å®¹å¯æäº¤"
            fi
          done

          git push || echo "æ— å†…å®¹å¯æ¨é€"

      - name: Try auto-merge PR after version bump
        if: github.ref_name != 'main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          branch_name=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: $branch_name"

          # åˆå¹¶ä¸»åˆ†æ”¯ä»¥é¿å… not mergeable
          git fetch origin main
          git merge origin/main --no-edit || git rebase origin/main
          git push origin "$branch_name"

          # è·å– PR ç¼–å·
          pr_number=$(gh pr list --state open --head "$branch_name" --json number -q '.[0].number')
          if [ -z "$pr_number" ]; then
            echo "No PR found for branch $branch_name"
            exit 0
          fi

          echo "Found PR #$pr_number, checking mergeability..."

          # ç­‰å¾… PR å¯åˆå¹¶çŠ¶æ€ï¼ˆæœ€å¤šé‡è¯• 10 æ¬¡ï¼‰
          for i in {1..10}; do
            is_mergeable=$(gh pr view "$pr_number" --json mergeable -q '.mergeable')
            echo "Mergeable status: $is_mergeable"
            if [ "$is_mergeable" == "MERGEABLE" ]; then
              break
            fi
            echo "PR not mergeable yet, retrying in 5s... ($i/10)"
            sleep 5
          done

          # å†æ¬¡æ£€æŸ¥å¹¶å°è¯•åˆå¹¶
          is_mergeable=$(gh pr view "$pr_number" --json mergeable -q '.mergeable')
          if [ "$is_mergeable" == "MERGEABLE" ]; then
            echo "PR is mergeable now, merging..."
            gh pr merge "$pr_number" --merge --delete-branch --admin
          else
            echo "PR is still not mergeable, skipping merge."
          fi

          